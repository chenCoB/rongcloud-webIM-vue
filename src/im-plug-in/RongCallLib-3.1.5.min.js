/*
* RongCallLib.js v3.1.5
* Release Date: Tue Sep 17 2019 10:09:51 GMT+0800 (China Standard Time)
* Copyright 2019 RongCloud
* Released under the MIT License.
*/(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):a.RongCallLib=b()})(this,function(){'use strict';var a={camera:!0},b=function(){},c=function(a){return"[object Array]"===Object.prototype.toString.call(a)},d=function(a,d){d=d||b;var e=function(){for(var b in a)d(a[b],b,a)},f=function(){for(var b=0;b<a.length;b++)d(a[b],b,a)},g=c(a),h=g?f:e;h()},e=function(){var a,b,c=navigator.userAgent,d={IE:/rv:([\d.]+)\) like Gecko|MSIE ([\d.]+)/,Edge:/Edge\/([\d.]+)/,Firefox:/Firefox\/([\d.]+)/,Opera:/(?:OPERA|OPR).([\d.]+)/,WeChat:/MicroMessenger/i,QQBrowser:/QQBrowser\/([\d.]+)/,Chrome:/Chrome\/([\d.]+)/,Safari:/Version\/([\d.]+).*Safari/,iOSChrome:/Mobile\/([\d.]+).*Safari/};for(var e in d)if(d.hasOwnProperty(e)){var f;if(f=c.match(d[e])){b=e,a=f[1]||f[2];break}}return{type:b?b:"UnKonw",version:a?a:"UnKonw"}},f={noop:b,ObserverList:function(){var a=function(a,b){return-1<a&&a<b};this.observerList=[],this.add=function(a,b){b&&(this.observerList.length=0),this.observerList.push(a)},this.get=function(b){if(a(b,this.observerList.length))return this.observerList[b]},this.count=function(){return this.observerList.length},this.removeAt=function(b){a(b,this.observerList.length)&&this.observerList.splice(b,1)},this.remove=function(a){if(!a)return void(this.observerList.length=0);a="[object Function]"==Object.prototype.toString.call(a)?[a]:a;for(var b=0,c=this.observerList.length;b<c;b++)if(this.observerList[b]===a[b]){this.removeAt(b);break}},this.notify=function(a){for(var b=0,c=this.observerList.length;b<c;b++)this.observerList[b](a)},this.indexOf=function(a,b){for(var c=b||0,d=this.observerList.length;c<d;){if(this.observerList[c]===a)return c;c++}return-1}},cache:function(){var a={},b=function(b,c){a[b]=c},c=function(b){return a[b]},d=function(b){delete a[b]};return{set:b,get:c,update:function(a,c){b(a,c)},remove:d,clear:function(){a={}}}},forEach:d,extend:function(a,b){for(var c in b)a[c]=b[c];return a},array2Obj:function(a){var b={};return d(a,function(a){b[a]=a}),b},isNumber:function(a){return"[object Number]"==Object.prototype.toString.call(a)},isArray:c,isObject:function(a){return"[object Object]"===Object.prototype.toString.call(a)},isSupportedBrowser:function(){var a=e(),b=a.type;return-1!==["Chrome","Safari","IE"].indexOf(b)},isSupportedPlatform:function(){for(var a=navigator.userAgent,b=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],c=!0,d=0;d<b.length;d++)if(0<a.indexOf(b[d])){c=!1;break}return c},isSupportedProtocol:function(){var a=location.hostname,b=location.protocol,c=e();return!("IE"!==c.type)||"localhost"===a||"127.0.0.1"===a||-1!==b.indexOf("https")},console:console,getVideoAudioStream:function(a,b){var c=!0;return a&&b&&(c={width:a,height:b}),navigator.mediaDevices.getUserMedia({video:c,audio:!0}).then(function(a){return a},function(){return navigator.mediaDevices.getUserMedia({video:!0,audio:!1})}).then(function(a){return a},function(){return navigator.mediaDevices.getUserMedia({video:!1,audio:!0})})},getAudioStream:function(){return navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then(function(a){for(var b=a.getVideoTracks(),c=0,d=b.length;c<d;c++)b[c].enabled=!1;return Promise.resolve(a)},function(){return a.camera=!1,navigator.mediaDevices.getUserMedia({video:!1,audio:!0})})},deviceEnable:a},g=void 0,h=void 0,i=function(){return g},j=function(){return h},k={getRongIMLib:i,setRongIMLib:function(a){g=a},getRongRTC:j,setRongRTC:function(a){h=a}},l={Reason:{CANCEL1:{code:1,info:"\u5DF1\u65B9\u53D6\u6D88\u5DF2\u53D1\u51FA\u7684\u901A\u8BDD\u8BF7\u6C42"},REJECT2:{code:2,info:"\u5DF1\u65B9\u62D2\u7EDD\u6536\u5230\u7684\u901A\u8BDD\u8BF7\u6C42"},HANGUP3:{code:3,info:"\u5DF1\u65B9\u6302\u65AD"},BUSYLINE4:{code:4,info:"\u5DF1\u65B9\u5FD9\u788C"},NO_RESPONSE5:{code:5,info:"\u5DF1\u65B9\u672A\u63A5\u542C"},ENGINE_UN_SUPPORTED6:{code:6,info:"\u5DF1\u65B9\u4E0D\u652F\u6301\u5F53\u524D\u5F15\u64CE"},NETWORK_ERROR7:{code:7,info:"\u5DF1\u65B9\u7F51\u7EDC\u51FA\u9519"},OTHER_CLIENT_HANDLED8:{code:8,info:"\u5176\u4ED6\u8BBE\u5907\u5DF2\u5904\u7406"},REMOTE_CANCEL11:{code:11,info:"\u5BF9\u65B9\u53D6\u6D88\u5DF2\u53D1\u51FA\u7684\u901A\u8BDD\u8BF7\u6C42"},REMOTE_REJECT12:{code:12,info:"\u5BF9\u65B9\u62D2\u7EDD\u6536\u5230\u7684\u901A\u8BDD\u8BF7\u6C42"},REMOTE_HANGUP13:{code:13,info:"\u901A\u8BDD\u8FC7\u7A0B\u5BF9\u65B9\u6302\u65AD"},REMOTE_BUSYLINE14:{code:14,info:"\u5BF9\u65B9\u5FD9\u788C"},REMOTE_NO_RESPONSE15:{code:15,info:"\u5BF9\u65B9\u672A\u63A5\u542C"},REMOTE_ENGINE_UN_SUPPORTED16:{code:16,info:"\u5BF9\u65B9\u4E0D\u652F\u6301\u5F53\u524D\u5F15\u64CE"},REMOTE_NETWORK_ERROR17:{code:17,info:"\u5BF9\u65B9\u7F51\u7EDC\u9519\u8BEF"},VOIP_NOT_AVALIABLE18:{code:18,info:"VoIP \u4E0D\u53EF\u4EE5\u7528"},DEVICE_ERROR:{code:19,info:"\u83B7\u53D6\u9EA6\u514B\u98CE\u6216\u6444\u50CF\u5934\u5931\u8D25"}},CallStatus:{//鍒濆鐘舵€�
        CallIdle:0,//姝ｅ湪鍛煎嚭
        Dialing:1,//姝ｅ湪鍛煎叆
        Incoming:2,//鏀跺埌涓€涓€氳瘽鍛煎叆鍚庯紝姝ｅ湪鎸搩
        Ringing:3,//姝ｅ湪閫氳瘽
        Active:4,//宸茬粡鎸傛柇
        Hangup:5}},m=l.Reason,n={OnlyAudio:0,All:1,OnlyVideo:2,None:3},o="RongCloudRTC",p=void 0,q=void 0,r=void 0,s=void 0,t=f.noop,u={VIDEO_PROFILE_240P:{width:320,height:240},VIDEO_PROFILE_480P:{width:640,height:480},VIDEO_PROFILE_720:{width:1280,height:720}},v={},w=function(){if(!q)throw new Error("Not call yet, please call first.");return q},x=function(a,b){var c;return c=a&&b?n.All:a?n.OnlyVideo:b?n.OnlyAudio:n.None,c},y=function(a,b){var c=document.createElement("video");return c.id=b,c.autoplay=!0,c.controls=!1,c.srcObject=a,c},z=function(a){/*  id = id || 'local';
    let prefix = 'native-';*/return(/*prefix + */a)},A=function(a){var b=a.id,c=a.stream,d=b===p,e=void 0,f=void 0,g=void 0;if(c){var h=c.enable,i=c.mediaStream,j=z(b);e=y(i,j),f=x(h.video,h.audio),e.muted=b===p,e.setAttribute("userid",b),g=c.tag}var k={type:"added",data:e,talkType:f,isLocal:d,tag:g};t(null,k)},B=function(a){var b=a.id,c=a.stream,d=c.enable,e=d.video,f=d.audio,g=c.tag,h=b===p,i=x(e,f);t(null,{type:"added",talkType:i,isLocal:h,tag:g})},C=function(a){var b=q.StreamSize;a.stream.size=b.MAX,s.subscribe(a).then(function(a){v.isIE?B(a):A(a)},function(a){console.error(a),t("stream subscribe error")})},D=function(a){a=a||{};var b={type:"removed",data:a.id,userId:a.id,isLocal:!1};t(null,b)},E=function(a,b){var c=k.getRongIMLib(),d=c.VoIPMediaType,e=q.StreamType,g=a===d.MEDIA_AUDIO?e.AUDIO:e.AUDIO_AND_VIDEO,h={id:p},i=a===d.MEDIA_VEDIO,j=i?f.getVideoAudioStream:f.getAudioStream;return j(v.width,v.height).then(function(a){h.stream={mediaStream:a,type:g,tag:o},b(null,h)}).catch(function(){b(null,h)})},F=function(a){var b=a.mediaType,c=k.getRongIMLib(),d=c.VoIPMediaType,e=q.StreamType,f=b===d.MEDIA_AUDIO?e.AUDIO:e.AUDIO_AND_VIDEO,g={id:p,stream:{tag:o,type:f,enable:{video:b!==d.MEDIA_AUDIO,audio:!0}}};s.publish(g).then(function(){}).catch(function(a){console.error("publish self stream error",a)}),B(g)},G=function(a){var b=k.getRongIMLib(),c=b.VoIPMediaType,d=s.video;E(a.mediaType,function(b,e){return b?t(m.DEVICE_ERROR.code,m.DEVICE_ERROR.info):void(e.isLocal=!0,e.stream?(s.publish(e).then(function(){a.mediaType===c.MEDIA_AUDIO&&d.disable({id:p,stream:{tag:o}})},function(a){console.error("publish self stream error",a)}),e.stream.enable={video:a.mediaType!==c.MEDIA_AUDIO,audio:!0}):console.error("Microphone and camera not captured, Can't get your own stream"),A(e))})},H=function(a){r=new q.Room({id:a,// joined: , // 鍏朵粬浜哄姞鍏ヤ笉澶勭悊, 宸查€氳繃娑堟伅澶勭悊
    left:D})},I=function(){return s=new q.Stream({published:C// unpublished: '', 瀵规柟鍙栨秷鎺ㄦ祦, 涓嶅鐞�, calllib 鍙湁閫€鍑�, 娌℃湁鍙栨秷
// disabled: '',  璧勬簮鏀瑰彉, 涓嶅鐞�, 宸查€氳繃娑堟伅澶勭悊
// enabled: '',
// muted: '',
// unmuted: ''
}),s},J=function(a){H(a.channelId)},K=function(a){f.extend(v,a),a.engineId&&(v.isIE=!0);var b=k.getRongRTC(),c=k.getRongIMLib();return q=new b({id:v.engineId,RongIMLib:c,mode:b.RTC,error:function(a){t(null,{type:"error",error:a})}}),I(),s},L=function(a,b){t=b||f.noop,p=a.userId,J(a);var c={id:p,token:p};r.join(c).then(function(){v.isIE?F(a):G(a)},function(a){console.log("join room error",a),t("join error.")})},M=function(a,b){return b=b||f.noop,q&&r?void r.leave().then(function(){t(null,{type:"leave"}),b()},function(){b(),t("leave error.")}):b()},N=function(a){var b=!a.isEnabled,c=s.audio,d=b?c.mute:c.unmute;d({id:p,stream:{tag:o}})},O=function(a){var b=!a.isEnabled,c=s.video,d=b?c.disable:c.enable;d({id:p,stream:{tag:o}})},P=function(){var a=q.ScreenShare;a.start().then(function(){},function(){t("screenshare error.")})},Q=function(){var a=q.ScreenShare;a.stop()},R=function(){var a=q.WhiteBoard;a.create().then(function(a){if(a.url){var b={index:"meet",type:"whiteBoardURL",url:a.url};t(b)}else t("request whiteboard error.")})},S={setConfig:K,joinRoom:L,quitRoom:M,enableAudio:N,enableVideo:O,getMediaID:function(a){var b=a.sentTime;return(2147483647&b)+"";//ios o鍙敮鎸乻tring 绫诲瀷
    },startScreenShare:P,stopScreenShare:Q,requestWhiteBoardURL:R,setVideoProfile:function(a){var b=u[a]||u[u.VIDEO_PROFILE_480P];f.extend(v,b)},getRTCPeer:w},T=f.ObserverList,U=[],V=function(){return k.getRongIMLib()},W=function(a){var b=V(),c={AcceptMessage:b.AcceptMessage,RingingMessage:b.RingingMessage,SummaryMessage:b.SummaryMessage,HungupMessage:b.HungupMessage,InviteMessage:b.InviteMessage,MediaModifyMessage:b.MediaModifyMessage,MemberModifyMessage:b.MemberModifyMessage},d=a.content,e=c[a.messageType]||f.noop;return new e(d)},X=function(a,b){var c=V();b=b||f.noop;var d=W(a),e=a.conversationType,g=a.targetId,h=c.RongIMClient.getInstance(),i=a.pushText||"",j=a.appData||"";// console.log('im.sendMessage', msg);
    h.sendMessage(e,g,d,{onSuccess:function(a){U.unshift(a.messageUId),U.length>500&&U.pop();b(null,a)},onError:function(a){b(a)}},!1,i,j,null,a)},Y={/*
        params.conversationType
        params.targetId
        params.content
        */invite:function(a,b){a.messageType="InviteMessage";var c=a.content,d=c.mediaType,e=c.inviteUserIds,f=c.callId;a.pushText={1:"\u60A8\u6709\u4E00\u6761\u97F3\u9891\u901A\u8BDD",2:"\u60A8\u6709\u4E00\u6761\u89C6\u9891\u901A\u8BDD"}[d],a.appData=JSON.stringify({mediaType:d,userIdList:e,callId:f}),a.userIds=e,X(a,b)},ringing:function(a,b){a.messageType="RingingMessage",X(a,b)},/*
        params.conversationType
        params.targetId
        params.content
        */accept:function(a,b){a.messageType="AcceptMessage",X(a,b)},/*
       params.conversationType
       params.targetId
       params.content
       */hungup:function(a,b){a.messageType="HungupMessage",X(a,b)},/*
        params.conversationType
        params.targetId
        params.content
        */mediaModify:function(a,b){a.messageType="MediaModifyMessage",X(a,b)},memberModify:function(a,b){a.messageType="MemberModifyMessage";var c=a.content,d=[],e=c.inviteUserIds,g=c.existedMemberStatusList;f.forEach(e,function(a){d.push(a)}),f.forEach(g,function(a){var b=a.userId;d.push(b)}),a.userIds=d,X(a,b)},getToken:function(a,b){// const RongIMLib = getIMPeer();
// let im = RongIMLib.RongIMClient.getInstance();
// let engineType = 3;
// let channelId = params.channelId;
        b(null,"")}},Z=new T,$=function(){var a=V();if(!a)return console.error("Missing RongIMLib, please pass in RongIMLib in init"),"";var b=a.RongIMClient||{getInstance:function(){return{getCurrentUserId:f.noop}}},c=b.getInstance().getCurrentUserId();return c?c:(console.error("Please connect im first"),"")},_=function(){var a=V();// WebSDK VoIP message adapter.
    a.RongIMClient._voipProvider={onReceived:function(a){// console.log('onRecrived msd', message)
// patch 鎺掗櫎鑷繁鍙戠殑娑堟伅
            var b=-1<U.indexOf(a.messageUId);a.offLineMessage||b||Z.notify(a)}}},aa={sendCommand:function(a,b){var c=a.command,d=a.data;Y[c]&&Y[c](d,b)},watch:function(a){Z.add(a)},setVoipProvider:_,getCurrentUserId:$},ba=function(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")},ca=l.Reason,da=S.joinRoom,ea=S.quitRoom,fa=S.enableAudio,ga=S.enableVideo,ha=S.getMediaID,ia=aa.sendCommand,ja=aa.getCurrentUserId,ka=f.cache(),la=f.ObserverList,ma=new la,na=new la,oa=new la,pa=new la,qa={url:"https://rtcapi.ronghub.com/nav/websocketlist",timeout:30000,ices:[{urls:"turn:119.254.101.80:3478",credential:"test",username:"test"}]};ka.set("videoQueue",{});var ra={},sa={SENT:1,RECEIVED:2},ta=function(a){var b={};return["extra"].forEach(function(c){b[c]=a[c]}),b},ua={single:function(a){var b=a.senderUserId,c=ra[b];c&&c.stop()},multi:function(){f.forEach(ra,function(a){a.stop()}),ka.remove("inviteUsers")}},va={//鍒濆鐘舵€�
    CallIdle:0,//姝ｅ湪鍛煎嚭
    Dialing:1,//姝ｅ湪鍛煎叆
    Incoming:2,//鏀跺埌涓€涓€氳瘽鍛煎叆鍚庯紝姝ｅ湪鎸搩
    Ringing:3,//姝ｅ湪閫氳瘽
    Active:4,//宸茬粡鎸傛柇
    Hangup:5},wa=function(){// key 锛氱敤鎻忚堪鍜岄敊璇爜缁勬垚锛屾柟渚块€氳繃閿欓敊璇爜鎴栬€呮弿杩拌幏鍙�
    var a={CANCEL1:{code:1,info:"\u5DF1\u65B9\u53D6\u6D88\u5DF2\u53D1\u51FA\u7684\u901A\u8BDD\u8BF7\u6C42"},REJECT2:{code:2,info:"\u5DF1\u65B9\u62D2\u7EDD\u6536\u5230\u7684\u901A\u8BDD\u8BF7\u6C42"},HANGUP3:{code:3,info:"\u5DF1\u65B9\u6302\u65AD"},BUSYLINE4:{code:4,info:"\u5DF1\u65B9\u5FD9\u788C"},NO_RESPONSE5:{code:5,info:"\u5DF1\u65B9\u672A\u63A5\u542C"},ENGINE_UN_SUPPORTED6:{code:6,info:"\u5DF1\u65B9\u4E0D\u652F\u6301\u5F53\u524D\u5F15\u64CE"},NETWORK_ERROR7:{code:7,info:"\u5DF1\u65B9\u7F51\u7EDC\u51FA\u9519"},OTHER_CLIENT_HANDLED8:{code:8,info:"\u5176\u4ED6\u8BBE\u5907\u5DF2\u5904\u7406"},REMOTE_CANCEL11:{code:11,info:"\u5BF9\u65B9\u53D6\u6D88\u5DF2\u53D1\u51FA\u7684\u901A\u8BDD\u8BF7\u6C42"},REMOTE_REJECT12:{code:12,info:"\u5BF9\u65B9\u62D2\u7EDD\u6536\u5230\u7684\u901A\u8BDD\u8BF7\u6C42"},REMOTE_HANGUP13:{code:13,info:"\u901A\u8BDD\u8FC7\u7A0B\u5BF9\u65B9\u6302\u65AD"},REMOTE_BUSYLINE14:{code:14,info:"\u5BF9\u65B9\u5FD9\u788C"},REMOTE_NO_RESPONSE15:{code:15,info:"\u5BF9\u65B9\u672A\u63A5\u542C"},REMOTE_ENGINE_UN_SUPPORTED16:{code:16,info:"\u5BF9\u65B9\u4E0D\u652F\u6301\u5F53\u524D\u5F15\u64CE"},REMOTE_NETWORK_ERROR17:{code:17,info:"\u5BF9\u65B9\u7F51\u7EDC\u9519\u8BEF"},VOIP_NOT_AVALIABLE18:{code:18,info:"VoIP \u4E0D\u53EF\u4EE5\u7528"}},b=function(b){return f.isNumber(b)&&f.forEach(a,function(a,c){-1<c.indexOf(b)&&(b=c)}),b};return{get:function(c){return c=b(c),a[c]}}}(),xa={1:function(){return wa.get("REMOTE_CANCEL11")},2:function(){return wa.get("REMOTE_REJECT12")},3:function(){return wa.get("REMOTE_HANGUP13")},4:function(){return wa.get("REMOTE_BUSYLINE14")},5:function(){return wa.get("REMOTE_NO_RESPONSE15")},15:function(){return wa.get("NO_RESPONSE5")}},ya=function(){this.timeout=0,this.startTime=0,this.start=function(a,b){b=b||0,a&&(this.timeout=setTimeout(function(){a()},b)),this.startTime=+new Date},this.stop=function(){clearTimeout(this.timeout);var a=+new Date,b=this.startTime,c=a-b;return 0===b&&(c=0),{start:b,end:a,duration:c}},this.clear=function(){this.startTime=0}},za=new ya,Aa=function(a,b){var c=a.channelId;a={command:"getToken",engineType:4,data:{channelId:c}},ia(a,b)},Ba=function(a){var b=a.info;throw new Error(b)},Ca=function(a){a.session||Ba(a)},Da=function(a){var b=a?"single":"multi";ua[b](a)},Ea={isActive:!1,init:function(a,b){this.isActive||(a.url=qa.url,a.ices=qa.ices,da(a,b),this.isActive=!0)},reset:function(){this.isActive=!1,ka.remove("session"),ka.remove("initRoom")}},Fa=function(a){var b=a.session||ka.get("session"),c=wa.get(a.reasonKey),d=b.conversationType,e=b.targetId,f=za.stop();za.clear();var g=b.senderUserId,h=b.senderUserId,i=b.content,j=i.mediaType,k=i.inviteUserIds,l=b.userOnLine||{};if(1===d&&l[g]){var m=xa[c.code];m&&(c=m())}var n={conversationType:d,targetId:e,messageDirection:b.messageDirection,content:{caller:g,inviter:h,mediaType:j,startTime:f.start,duration:f.duration,status:c.code,memberIdList:k},senderUserId:h,messageType:"SummaryMessage"};return oa.notify(n),Ea.reset(),ka.remove("hungupReason"),n},Ga=function(a,b){b=b||f.noop;var c=ka.get("session");a.session=c;var d=a.from;Ca({session:c,info:d+": Not call yet"});var e=c.content.callId,g=c.conversationType,h=c.targetId,i=a.reasonKey,j=wa.get(i),k=!a.passive;// 鐐瑰嚮鎸傛柇鎸夐挳瑙﹀彂鏃跺彂閫佹秷鎭紝鎺ュ彈鍒� HungupMessage 鏃朵笉鍙戦€佹秷鎭�
    if(k){var l={command:"hungup",data:{conversationType:g,targetId:h,content:f.extend({callId:e,reason:j.code},ta(a))}};ea({roomId:e},function(){ia(l,function(c){if(!c){var d=Fa(a);b(null,d)}})})}else ea({roomId:e},function(){var c=Fa(a);b(null,c)});ka.get("joinRoom")&&ka.remove("joinRoom"),Da()},Ha=function(a){var b=a.userIds,c=a.conversationType,d=a.targetId,e=ja()||qa.currentUserId;f.forEach(b,function(b){var f=ra[b]=new ya,g=b===e||1===c,h=a.status;f.status=h,f.mediaType=a.mediaType;var i=qa.timeout;g||(i+=a.timeout||0);var j={sent:function(a){// 涓€鐩村浜庡懠鍙姸鎬佽涓哄鏂逛笉鍦ㄧ嚎銆�
        var b=a.status===va.Dialing,e=b?"REMOTE_NO_RESPONSE15":"NO_RESPONSE5",f=ka.get("inviteUsers");Ga({conversationType:c,targetId:d,from:"call-timeout",reasonKey:e},function(a,b){var c=b.senderUserId;delete f[c]})},local:function()/*callback*/{var a=wa.get("NO_RESPONSE5"),e=ka.get("session"),f={reason:a.code,callId:e.content.channelInfo.Id};// let error = null;
        pa.notify({messageType:"HungupMessage",conversationType:c,targetId:d,senderUserId:b,content:f,messageDirection:2})}};f.start(function(){// 鎺ユ敹鑰呬负鑷繁鏃跺彂閫� HungupMessage, 鍏朵粬浜哄垯鏈湴鍒涘缓 HungupMessage锛岃涓烘浜哄凡蹇界暐銆佹垨鑰呬笉鍦ㄧ嚎銆�
    var a=g?"sent":"local";j[a](f)},i)})},Ia=function(a,b,c){Aa(a,function(d,e){if(d)throw new Error(d);a.token=e;var g={added:function(a){var b=a.data,c=b.getAttribute("userid");// App Server 鐨勭敤鎴� Id
        a.userId=c,b.setAttribute("userId",c)}};Ea.init(a,function(a,d){if(b=b||f.noop,a)throw b(a,d),new Error(a);if("error"===d.type)throw Fa({reasonKey:"NETWORK_ERROR7"}),new Error("RTC Connect Error.");// return callback(null, summary);
    if(!d.isLeft)// 绂诲紑浜嬩欢
//   room.reset();
    {"added"===d.type&&d.isLocal&&b(null,c);var e=d.type,h=d.index,i=g[e];if(i&&i(d),"meet"===h)na.notify(d);else{var j=d.sourceId,k=d.userId;if(+k!==j)ma.notify(d);else{var l=ka.get("videoQueue");l[j]=d}}}})})},Ja=function(a){var b={};return f.forEach(a,function(a){b[a]=a}),b},Ka=function(a){return 3===a},La=function(a,b){var c=ka.get("session");return c[a]=b,c[b]=a,{userId:b,sender:a}},Ma=function(a){// let sentTime = params.sentTime;
    var b=a.senderUserId,c=ha(a);// console.log('addUserRelation:sentTime->userId', sentTime, '->', senderUserId);
    return La(b,c)},Na={busy:function(a){var b="BUSYLINE4",c=wa.get(b),d=1===a.messageDirection;d&&(b="HANGUP3");var e=a.content.callId,f={callId:e,reason:c.code},g=a.conversationType,h=a.targetId;ia({command:"hungup",data:{conversationType:g,targetId:h,content:f}})},free:function(a,b,c){ka.set("session",a),oa.notify(a);var d=a.sentTime,e=a.senderUserId;b?Ma({sentTime:d,senderUserId:e}):a.content.existedUserPofiles.map(function(a){La(a.userId,a.mediaId)});var f=a.content,g=f.callId,h=a.conversationType,i=a.targetId,j=f.inviteUserIds;ka.set("inviteUsers",Ja(j));var k=f.mediaType,l={conversationType:h,targetId:i,userIds:j,mediaType:k,status:va.Incoming};// 绉诲姩绔涓€娆″悜pc绔彂璧峰崟涓兢鑱�
        if(Ha(l),c){var m={conversationType:h,targetId:i,userIds:[a.senderUserId],mediaType:k,status:va.Active};Ha(m),Da(a);ia({command:"ringing",data:{conversationType:h,targetId:i,content:{callId:g}}})}}},Oa=function(a){var b=ka.get("videoQueue"),c=a.data,d=c.getAttribute("userid"),e=ka.get("session");d in e&&(delete b[d],d=e[d]||d,a.sourceId=d,c.setAttribute("userid",d),ma.notify(a))},Pa=function(a){var b=a.conversationType,c=a.targetId,d=ka.get("session"),e=d.senderUserId,f=e,g=d.content,h=g.mediaType,i=g.inviteUserIds,j=wa.get("OTHER_CLIENT_HANDLED8"),k={conversationType:b,targetId:c,messageDirection:2,content:{caller:e,inviter:f,mediaType:h,startTime:0,duration:0,status:j.code,memberIdList:i},senderUserId:f,messageType:"SummaryMessage"};oa.notify(k),ka.remove("session")},Qa={InviteMessage:function(a){var b=ka.get("session"),c=b?"busy":"free";Na[c](a,!0,!0)},RingingMessage:function(a){var b=a.senderUserId,c=ra[b];c&&(c.stop(),c.status=va.Ringing);var d=ka.get("session");if(d){var e=d.userOnLine||{};e[b]=!0,d.userOnLine=e,oa.notify(a)}},AcceptMessage:function(a){function b(){return ka.get("initRoom")&&f===ja()}function c(){return f===ja()}var d=ka.get("session");if(d)// 宸辨柟宸叉寕鏂�, 鍐嶆敹鍒板鏂� accept 娑堟伅鏃�
    {var e=d.params,f=d.senderUserId;!b()&&c()&&(ka.set("initRoom",!0),Ia(e));// let already = session.already;
        var g=a.senderUserId,h=a.sentTime,i=Ma({sentTime:h,senderUserId:g}),j=ka.get("videoQueue"),k=j[i.userId]||j[i.sender];// 瀛樺偍鐢ㄦ埛淇℃伅鏍囪瘑
        k&&Oa(k);var l=1===a.messageDirection;if(l)return void Pa(a);// if (already) {
//     return;
// }
        var m=a.content;a.callInfo={mediaType:m.mediaType,status:va.Active},Da(a);var n=d.content.channelInfo,o=n.Id,p=d.callInfo||{};if(p[o]){d.already=!0,za.start();var q=ra[g]||{};q.status=va.Active,oa.notify(a)}}},HungupMessage:function(a){var b=ka.get("inviteUsers")||{},c=a.senderUserId,d=ka.get("session");if(d){var e=d.content,g=e.channelInfo.Id,h=a.content,i=h.callId;if(g===i){a.callInfo={mediaType:e.mediaType,status:va.Hangup},Da(a),delete b[c],delete ra[c];// 鎸傛柇鍦ㄩ個璇�
        var j=a.messageDirection===sa.RECEIVED;if(j){var k=a.content,l=k.reason;3===l&&0===za.startTime&&(l=2);var m=xa[l]||f.noop,n=m()||{};l=n.code||l,a.content.reason=l,ka.set("hungupReason",l)}else Pa(a);oa.notify(a)}}},MediaModifyMessage:function(a){oa.notify(a)},MemberModifyMessage:function(a){a.content.existedUserPofiles?a.content.existedMemberStatusList=a.content.existedUserPofiles:a.content.existedUserPofiles=a.content.existedMemberStatusList,Na.free(a,!1,!1)},otherMessage:function(a){oa.notify(a)}};(function(a){pa.add(a)})(function(a){var b=a.messageType;b=b in Qa?b:"otherMessage";var c=Qa[b];c(a)});var Ra=function(a){var b=Math.floor(1e3*Math.random()),c=[a.conversationType,a.targetId,b];return c.join("_")},Sa=function(a,b){var c=a.content,d=c.callId,e=c.mediaType,g=a.isSharing,h=c.inviteUserIds,i=a.conversationType,j=a.targetId;ka.set("inviteUsers",Ja(h));ia({command:"invite",data:a},function(a,c){a&&b({code:a});var k={};k[d]=!0,c.callInfo=k,c.isSharing=g;//涓诲彨鏂� userId 涓� inviterMessage.sentTime
//琚彨鏂� userId 涓� AcceptMessage.sentTime
    var l=c.sentTime,m=c.senderUserId,n=c.userOnLine={};f.forEach(h,function(a){n[a]=!1}),ka.update("session",c),Ma({sentTime:l,senderUserId:m});c.params={channelId:d,userId:m,sentTime:l,mediaType:e,isSharing:g},b({code:a},c);var o={conversationType:i,targetId:j,userIds:h,timer:10,mediaType:e,status:va.Dialing};Ha(o);//self
    var p={conversationType:i,targetId:j,userIds:[m],timer:10,mediaType:e,status:va.Active};Ha(p),Da(c)})},Ta=function(a,b){var c=ka.get("session");if(c){return void b(wa.get("BUSYLINE4"))}var d=a.engineType||4;ka.set(b,a),b=b||f.noop;var e=a.conversationType,g=a.targetId,h=a.inviteUserIds,i=a.mediaType,j=a.isSharing,k=Ra(a),l=a.observerUserIds||[],m={isSharing:j,conversationType:e,targetId:g,content:f.extend({sharing:j,engineType:d,inviteUserIds:h,observerUserIds:l,mediaType:i,callId:k,channelInfo:{Key:"",Id:k}},ta(a))};Sa(m,function(a,c){b(a.code,c)})},Ua=function(a,b){var c=a.content,d=c.inviteUserIds,e=ka.get("inviteUsers");f.forEach(d,function(a){e[a]=a});var g=a.conversationType,h=a.targetId,i=a.content.mediaType;// console.log('send memberModify', data);
    ia({command:"memberModify",data:a},function(a,c){a={code:a},b(a,c);var e={conversationType:g,targetId:h,userIds:d,timer:10,mediaType:i,status:va.Dialing};Ha(e)})},Va=function(a,b){var c=ka.get("session");Ca({session:c,info:"Invite: Not call yet"}),b=b||f.noop,c=ka.get("session");var d=a.conversationType,e=a.targetId,g=c.content,h=g.callId,i=c.senderUserId,j=a.engineType||4,k=a.mediaType,l=a.inviteUserIds,m=[];f.forEach(ra,function(a,b){var d=c[b],e={userId:b,mediaId:ha({sentTime:d,userId:b}),//ios o鍙敮鎸乻tring 绫诲瀷
    mediaType:a.mediaType,callStatus:a.status};m.push(e)});var n=ja()||qa.currentUserId,o=c[n],p={userId:n,mediaId:ha({sentTime:o,userId:n}),mediaType:k,callStatus:va.Active},q=m.map(function(a){return a.userId});0>q.indexOf(p.userId)&&m.push(p);var r=a.observerUserIds||[],s={conversationType:d,targetId:e,content:f.extend({modifyMemType:1,callId:h,caller:i,engineType:j,channelInfo:{Key:"",Id:h},mediaType:k,inviteUserIds:l,existedMemberStatusList:m,existedUserPofiles:m,observerUserIds:r,extra:a.extra},ta(a))};Ua(s,b)},Wa=function(a,b){b=b||f.noop;var c=a.conversationType,d=a.targetId,e=a.userType,g=a.mediaType,h=a.isSharing,i=ka.get("session"),j=a.from;Ca({session:i,info:j+": Not call yet"});var k=a.engineType,l=i.content,m=l.callId;a={command:"accept",data:{conversationType:c,targetId:d,content:f.extend({callId:m,mediaType:g},ta(a))}},ia(a,function(a,d){if(a)return b(a);var f=d.sentTime,i=l.callId,j=d.senderUserId;d.callInfo={mediaType:l.mediaType,status:va.Active},Da(d),Ma({sentTime:f,senderUserId:j});ra[j].status=va.Active,3===c&&ka.set("joinRoom",!0),Ia({channelId:i,userId:j,sentTime:f,mediaType:g,isSharing:h,engineType:k,userType:e},b,d),za.start()})},Xa=function(a,b){a.form="accept",Wa(a,b)},Ya=function(a){a.form="join",Wa(a)},Za=function(a,b){a.from="hungup";var c="CANCEL1";f.forEach(ra,function(a,b){a.status===va.Active&&b!==ja()&&(c="HANGUP3")});var d=a.conversationType;a.passive&&(c=ka.get("hungupReason")||c,Ka(d)&&(ra[ja()].status===va.Active?c="REMOTE_HANGUP13":c="NO_RESPONSE5")),a.reasonKey=c,Ga(a,b)},$a=function(a,b){a=a||{},a.from="reject",a.reasonKey="REJECT2",Ga(a,b)},_a=function(){fa({isEnabled:!1})},ab=function(){fa({isEnabled:!0})},bb=function(a,b){var c=ka.get("session"),d=c.content,e=d.callId,f=c.conversationType,g=c.targetId;c.content.mediaType=a,ka.get("session",c),ia({command:"mediaModify",data:{conversationType:f,targetId:g,content:{callId:e,mediaType:a}}},b)},cb=function(a){ga({isEnabled:!1});bb(1,a)},db=function(a){var b=f.deviceEnable;if(!b.camera)return a&&a(ca.DEVICE_ERROR.code,ca.DEVICE_ERROR.info);ga({isEnabled:!0});bb(2,a)},eb=function(){S.requestWhiteBoardURL()},fb=function(a){ma.add(a)},gb=function(a){na.add(a)},hb=function(a){oa.add(a)},ib={20:"VIDEO_PROFILE_240P",40:" VIDEO_PROFILE_480P",50:"VIDEO_PROFILE_720P"},jb=function(a){var b=ib[a];S.setVideoProfile(b)},kb=function(a){S.startScreenShare(a)},lb=function(){S.stopScreenShare()},mb=function(a,b){return a.watch?a.watch(function(a){pa.notify(a)}):aa.watch(function(a){pa.notify(a)}),{videoWatch:fb,commandWatch:hb,call:Ta,invite:Va,accept:Xa,hungup:Za,reject:$a,join:Ya,mute:_a,unmute:ab,videoToAudio:cb,audioToVideo:db,meetCommandWatche:gb,requestWhiteBoardURL:eb,startScreenShare:kb,stopScreenShare:lb,setVideoProfile:jb,rongRTCStream:b}},nb=function a(b){if(ba(this,a),!b.RongIMLib)throw new Error("\u8BF7\u5F15\u5165\u8BF7\u5F15\u5165 Web SDK : http://www.rongcloud.cn/docs/web.html#sdk");f.extend(qa,b),k.setRongIMLib(b.RongIMLib),k.setRongRTC(b.RongRTC),aa.setVoipProvider();var c=S.setConfig(qa);return b.sendCommand&&(ia=b.sendCommand),mb(b,c)};return{init:function(a){try{f.isSupportedBrowser()||f.console.error("This browser is not supported at this time. Please use Chrome 57+ or Safari 12+ to access it"),f.isSupportedPlatform()||f.console.error("Mobile is not supported at this time, please use PC to access"),f.isSupportedProtocol()||f.console.error("The web site must be localhost or https")}catch(a){f.console.error("init error",a)}return new nb(a)}}});
